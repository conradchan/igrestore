<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Unfollower Finder</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #262626;
        }
        .header {
            background: #fff;
            border-bottom: 1px solid #dbdbdb;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .subtitle { color: #8e8e8e; font-size: 13px; margin-top: 4px; }
        .stats {
            display: flex;
            gap: 24px;
            padding: 16px 24px;
            background: #fff;
            border-bottom: 1px solid #dbdbdb;
        }
        .stat { text-align: center; }
        .stat .num { font-size: 22px; font-weight: 700; }
        .stat .label { font-size: 12px; color: #8e8e8e; margin-top: 2px; }
        .tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #dbdbdb;
            padding: 0 24px;
            overflow-x: auto;
        }
        .tab {
            padding: 14px 20px;
            font-size: 13px;
            font-weight: 600;
            color: #8e8e8e;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: color 0.15s, border-color 0.15s;
        }
        .tab:hover { color: #262626; }
        .tab.active { color: #262626; border-bottom-color: #262626; }
        .tab .count {
            background: #efefef;
            border-radius: 10px;
            padding: 1px 7px;
            font-size: 11px;
            margin-left: 6px;
            font-weight: 400;
        }
        .tab.active .count { background: #262626; color: #fff; }
        .toolbar {
            padding: 12px 24px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search {
            flex: 1;
            min-width: 200px;
            max-width: 360px;
            padding: 8px 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
            background: #efefef;
            outline: none;
        }
        .search:focus { border-color: #a8a8a8; background: #fff; }
        .toolbar select {
            padding: 8px 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 12px;
            padding: 12px 24px 40px;
        }
        .card {
            background: #fff;
            border: 1px solid #dbdbdb;
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: box-shadow 0.15s;
        }
        .card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            flex-shrink: 0;
            text-decoration: none;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f58529, #dd2a7b, #8134af);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 20px;
        }
        .info { flex: 1; min-width: 0; }
        .info .username-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .info .username-link {
            color: #262626;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
        }
        .info .username-link:hover { text-decoration: underline; }
        .info .full-name {
            color: #8e8e8e;
            font-size: 13px;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .info .meta {
            color: #8e8e8e;
            font-size: 11px;
            margin-top: 3px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .info .bio {
            color: #555;
            font-size: 12px;
            margin-top: 4px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .private-badge {
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 4px;
            background: #efefef;
            color: #8e8e8e;
            font-weight: 600;
        }
        .verified-badge { color: #3897f0; font-size: 14px; }
        .badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 2px;
        }
        .badge.not-following { background: #fff3f0; color: #ed4956; }
        .badge.pending { background: #fff8e6; color: #c77d00; }
        .badge.mutual { background: #e8f5e9; color: #2e7d32; }
        .badge.fan { background: #e3f2fd; color: #1565c0; }
        .status-deleted { opacity: 0.5; }
        .empty {
            text-align: center;
            padding: 60px 24px;
            color: #8e8e8e;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Instagram Unfollower Finder</h1>
        <div class="subtitle">Generated {{ results.generated_at[:16] }}</div>
    </div>

    <div class="stats">
        <div class="stat"><div class="num">{{ results.counts.followers }}</div><div class="label">Followers</div></div>
        <div class="stat"><div class="num">{{ results.counts.following }}</div><div class="label">Following</div></div>
        <div class="stat"><div class="num">{{ results.counts.mutual }}</div><div class="label">Mutual</div></div>
        <div class="stat"><div class="num">{{ results.counts.not_following_back }}</div><div class="label">Don't follow back</div></div>
        <div class="stat"><div class="num">{{ results.counts.pending_requests }}</div><div class="label">Pending</div></div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="not_following_back">Not Following Back<span class="count">{{ results.counts.not_following_back }}</span></div>
        <div class="tab" data-tab="pending">Pending Requests<span class="count">{{ results.counts.pending_not_following_back }}</span></div>
        <div class="tab" data-tab="mutuals">Mutuals<span class="count">{{ results.counts.mutual }}</span></div>
        <div class="tab" data-tab="fans">Fans<span class="count">{{ results.counts.fans }}</span></div>
    </div>

    <div class="toolbar">
        <input type="text" class="search" placeholder="Search username or name..." id="search">
        <select id="sort">
            <option value="alpha">A-Z</option>
            <option value="alpha-desc">Z-A</option>
            <option value="date-new">Newest first</option>
            <option value="date-old">Oldest first</option>
            <option value="followers-high">Most followers</option>
            <option value="followers-low">Fewest followers</option>
        </select>
        <select id="filter-privacy">
            <option value="all">All accounts</option>
            <option value="public">Public only</option>
            <option value="private">Private only</option>
        </select>
    </div>

    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none">No accounts match your search.</div>

    <script>
        const data = {
            not_following_back: {{ results.not_following_back | tojson }},
            pending: {{ results.pending_not_following_back | tojson }},
            mutuals: {{ results.mutuals | tojson }},
            fans: {{ results.fans | tojson }}
        };

        const profiles = {{ profiles | tojson }};
        const picSet = new Set({{ pic_set | tojson }});

        const badgeConfig = {
            not_following_back: { label: "Doesn't follow back", cls: "not-following" },
            pending: { label: "Pending", cls: "pending" },
            mutuals: { label: "Mutual", cls: "mutual" },
            fans: { label: "Fan", cls: "fan" }
        };

        let currentTab = "not_following_back";

        function getDate(item) {
            return item.followed_at || item.requested_at || item.followed_you_at || "";
        }

        function parseDate(str) {
            if (!str) return new Date(0);
            return new Date(str);
        }

        function esc(s) {
            const d = document.createElement("div");
            d.textContent = s;
            return d.innerHTML;
        }

        function render() {
            const query = document.getElementById("search").value.toLowerCase();
            const sort = document.getElementById("sort").value;
            const privacy = document.getElementById("filter-privacy").value;
            const badge = badgeConfig[currentTab];

            let items = [...data[currentTab]];

            // Enrich with profile data
            items = items.map(item => {
                const p = profiles[item.username] || {};
                return { ...item, ...p };
            });

            if (query) {
                items = items.filter(i =>
                    i.username.toLowerCase().includes(query) ||
                    (i.full_name || "").toLowerCase().includes(query) ||
                    (i.biography || "").toLowerCase().includes(query)
                );
            }

            if (privacy === "public") {
                items = items.filter(i => i.is_private === false);
            } else if (privacy === "private") {
                items = items.filter(i => i.is_private === true);
            }

            items.sort((a, b) => {
                switch (sort) {
                    case "alpha": return a.username.localeCompare(b.username);
                    case "alpha-desc": return b.username.localeCompare(a.username);
                    case "date-new": return parseDate(getDate(b)) - parseDate(getDate(a));
                    case "date-old": return parseDate(getDate(a)) - parseDate(getDate(b));
                    case "followers-high": return (b.followers || 0) - (a.followers || 0);
                    case "followers-low": return (a.followers || 0) - (b.followers || 0);
                }
            });

            const grid = document.getElementById("grid");
            const empty = document.getElementById("empty");

            if (items.length === 0) {
                grid.innerHTML = "";
                empty.style.display = "block";
                return;
            }
            empty.style.display = "none";

            grid.innerHTML = items.map(item => {
                const date = getDate(item);
                const letter = item.username[0].toUpperCase();
                const url = `https://instagram.com/${item.username}`;
                const hasPic = picSet.has(item.username);
                const isDeleted = item.status === "not_found";

                const avatarInner = hasPic
                    ? `<img src="/pics/${esc(item.username)}.jpg" alt="${esc(item.username)}" loading="lazy">`
                    : `<div class="avatar-placeholder">${letter}</div>`;

                let metaParts = [];
                if (item.followers != null) metaParts.push(`${item.followers.toLocaleString()} followers`);
                if (item.following != null) metaParts.push(`${item.following.toLocaleString()} following`);
                if (item.posts != null) metaParts.push(`${item.posts.toLocaleString()} posts`);

                let privacyBadge = "";
                if (item.is_private === true) privacyBadge = `<span class="private-badge">Private</span>`;
                if (item.is_private === false) privacyBadge = `<span class="private-badge" style="background:#e3f2fd;color:#1565c0">Public</span>`;

                let verifiedBadge = item.is_verified ? `<span class="verified-badge">&#10003;</span>` : "";

                let statusNote = "";
                if (isDeleted) statusNote = `<span class="private-badge" style="background:#fff3f0;color:#ed4956">Deleted</span>`;
                if (item.status === "login_required") statusNote = `<span class="private-badge" style="background:#fff8e6;color:#c77d00">Not fetched</span>`;

                return `
                    <div class="card ${isDeleted ? 'status-deleted' : ''}">
                        <a class="avatar" href="${url}" target="_blank">${avatarInner}</a>
                        <div class="info">
                            <div class="username-row">
                                <a class="username-link" href="${url}" target="_blank">@${esc(item.username)}</a>
                                ${verifiedBadge}${privacyBadge}${statusNote}
                            </div>
                            ${item.full_name ? `<div class="full-name">${esc(item.full_name)}</div>` : ""}
                            ${metaParts.length ? `<div class="meta">${metaParts.map(m => `<span>${m}</span>`).join("")}</div>` : ""}
                            ${item.biography ? `<div class="bio">${esc(item.biography)}</div>` : ""}
                            ${date && !metaParts.length ? `<div class="meta"><span>${date}</span></div>` : ""}
                        </div>
                        <span class="badge ${badge.cls}">${badge.label}</span>
                    </div>
                `;
            }).join("");
        }

        document.querySelectorAll(".tab").forEach(tab => {
            tab.addEventListener("click", () => {
                document.querySelector(".tab.active").classList.remove("active");
                tab.classList.add("active");
                currentTab = tab.dataset.tab;
                render();
            });
        });

        document.getElementById("search").addEventListener("input", render);
        document.getElementById("sort").addEventListener("change", render);
        document.getElementById("filter-privacy").addEventListener("change", render);

        render();
    </script>
</body>
</html>
